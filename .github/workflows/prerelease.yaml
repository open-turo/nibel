name: Prerelease

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:

concurrency:
  group: prerelease-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  prerelease-check:
    name: Prerelease check
    # Only run if PR has 'prerelease' label or workflow_dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'prerelease')
    runs-on: [ubuntu-latest]
    outputs:
      new-release-published: ${{ steps.prerelease-check.outputs.new-release-published }}
      new-release-version: ${{ steps.prerelease-check.outputs.new-release-version }}
    steps:
      - uses: open-turo/actions-jvm/prerelease@v2
        name: Prerelease check
        id: prerelease-check
        with:
          checkout-repo: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          artifactory-username: ${{ secrets.ARTIFACTORY_USERNAME }}
          artifactory-auth-token: ${{ secrets.ARTIFACTORY_PASSWORD }}
          create-prerelease: false # dry run
        env:
          ORG_GRADLE_PROJECT_artifactoryAuthToken: ${{ secrets.ARTIFACTORY_PASSWORD }}
          ORG_GRADLE_PROJECT_artifactoryUsername: ${{ secrets.ARTIFACTORY_USERNAME }}
      - name: Outputs
        run: |
          echo "[Dry run] Potential new prerelease published '${{ steps.prerelease-check.outputs.new-release-published }}'"
          echo "[Dry run] Potential new prerelease version '${{ steps.prerelease-check.outputs.new-release-version }}'"

  lint:
    name: Lint
    # Only run if PR has 'prerelease' label or workflow_dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'prerelease')
    runs-on: [ubuntu-latest]
    steps:
      - uses: open-turo/actions-jvm/lint@v2
        with:
          checkout-repo: true
          artifactory-username: ${{ secrets.ARTIFACTORY_USERNAME }}
          artifactory-auth-token: ${{ secrets.ARTIFACTORY_PASSWORD }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  prerelease:
    name: Prerelease
    runs-on: [ubuntu-latest]
    needs:
      - lint
      - prerelease-check
    if: needs.prerelease-check.outputs.new-release-published == 'true'
    steps:
      - name: checkout
        uses: actions/checkout@v6

      - name: Set up JDK
        uses: open-turo/action-setup-tools@v3

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - uses: open-turo/actions-jvm/prerelease@v2
        name: Create prerelease
        id: prerelease
        with:
          checkout-repo: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          artifactory-username: ${{ secrets.ARTIFACTORY_USERNAME }}
          artifactory-auth-token: ${{ secrets.ARTIFACTORY_PASSWORD }}
          create-prerelease: true # actually create the prerelease
        env:
          ORG_GRADLE_PROJECT_artifactoryUsername: ${{ secrets.ARTIFACTORY_USERNAME }}
          ORG_GRADLE_PROJECT_artifactoryAuthToken: ${{ secrets.ARTIFACTORY_PASSWORD }}
          # Maven Central publishing credentials
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ARTIFACTORY_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ARTIFACTORY_PASSWORD }}
          # GPG signing
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_KEY_PASSWORD }}

      - name: Prerelease output
        run: |
          echo "New prerelease published '${{ steps.prerelease.outputs.new-release-published }}'"
          echo "New prerelease version '${{ steps.prerelease.outputs.new-release-version }}'"
          echo "Pull request number '${{ steps.prerelease.outputs.pull-request-number }}'"
